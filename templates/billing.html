{% extends "base.html" %}
{% block title %}Billing History{% endblock %}
{% block content %}
  <h2>Billing & Subscription</h2>
  
  {% if request.query_params.get('message') == 'cancellation_scheduled' %}
    <div class="alert alert-success mb-4">
      Your subscription has been scheduled for cancellation at the end of your current billing period.
      You'll continue to have premium access until then.
    </div>
  {% endif %}
  
  {% if request.query_params.get('error') %}
    <div class="alert alert-danger mb-4">
      {% if request.query_params.get('error') == 'no_subscription' %}
        No active subscription found to cancel.
      {% elif request.query_params.get('error') == 'stripe_error' %}
        There was a problem with our payment provider. Please try again later.
      {% elif request.query_params.get('error') == 'db_error' %}
        A database error occurred. Please try again later.
      {% else %}
        An unexpected error occurred. Please try again later.
      {% endif %}
    </div>
  {% endif %}  {% if subscription %}
    <div class="card mb-4 p-3">
      <h3>Current Subscription</h3>
      <p>
        <strong>Plan:</strong> {{ subscription.plan_name|default:"Premium Plan" }}<br/>
        <strong>Status:</strong> {{ subscription.status|default:"active"|capitalize }}<br/>
        <strong>Period ends:</strong> {{ subscription.current_period_end|default:"Not available" }}
        {% if subscription.current_period_end == "Not available" and portal_url %}
          <small><a href="{{ portal_url }}" target="_blank">(View in Stripe Portal)</a></small>
        {% endif %}
        <br/>
        {% if next_invoice_date %}
          <strong>Next invoice date:</strong> {{ next_invoice_date }}<br/>
        {% elif portal_url %}
          <strong>Next invoice date:</strong> Not available <small><a href="{{ portal_url }}" target="_blank">(View in Stripe Portal)</a></small><br/>
        {% endif %}
      </p>
      
      <div class="button-group">
        {% if portal_url %}
          <a class="btn btn-primary me-2" href="{{ portal_url }}" target="_blank">
            Manage Subscription in Stripe Portal
          </a>
        {% endif %}
        {% if subscription.status|lower == 'active' %}
          <a class="btn btn-danger" href="/cancel-subscription">
            Cancel Subscription
          </a>
        {% elif subscription.status|lower == 'canceled' %}
          <span class="badge bg-warning text-dark">Will cancel at period end</span>
        {% else %}
          <a class="btn btn-danger" href="/cancel-subscription">
            Cancel Subscription
          </a>
        {% endif %}
      </div>
    </div>
  {% else %}
    <p>No active subscription on file.</p>
    <p><a href="/subscribe" class="btn btn-primary">Get Premium Access</a></p>
  {% endif %}
  <h2>Past Invoices</h2>
  {% if invoices %}
    <table class="table">
      <thead>
        <tr><th>Date</th><th>Amount</th><th>Status</th><th>PDF</th></tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
          <tr>
            <td>{{ inv.date }}</td>
            <td>{{ inv.amount }}</td>
            <td>{{ inv.status }}</td>
            <td><a href="{{ inv.pdf }}" target="_blank">Download</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="card mb-4 p-3">
      <p>No billing records found in the system.</p>
      {% if portal_url %}
        <p>You can view your complete billing history in the Stripe Customer Portal.</p>
        <a class="btn btn-outline-primary" href="{{ portal_url }}" target="_blank">
          View Billing History in Stripe Portal
        </a>
      {% elif subscription %}
        <p>For premium users without a Stripe account link, please contact support to view your billing history.</p>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}
